---
title: "results_markdown"
author: "ASM"
date: "13/01/2023 last updated 01/05/2023"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 100, digits = 4)
```

```{r data call in, include=FALSE}
library(lubridate)
library(sparkline)
library(webshot)
library(htmlwidgets)
library(formattable)
library(here)
library(lme4)
library(lmerTest)
library(rstatix)
library(papeR)
library(knitr)
library(waffle)
library(ggsankey)
library(dplyr)
library(tidyverse)
library(patchwork)
library(ggpubr)
library(broom)
library(janitor)
library(glmmTMB)
library(DHARMa)
library(betareg)
library(emmeans)
library(ggeffects)
library(mvtnorm)
library(boot)
library(bbmle)
library(performance)
library(see)

load(here("anonymized_data/final_merged_data.Rda"))
load(here("anonymized_data/final_data_no_exc.Rda"))
load(here("anonymized_data/final_data_strat.Rda"))
load(here("anonymized_data/longitudinal_data.Rda"))

#Saving my palette to use in visualizations
my_yellow<-"#FFC107"
my_orange<- "#D95F02"
my_blue<- "#1F78B4"
my_green<- "#33a02c"
my_purple<- "#683f6d"

```

## Methods

### Participants
```{r participants information, include=FALSE}
#### CONSTRUCTING AND DESCRIBING ALL RELEVANT DATA SETS ####

#Trilingul exclusions count
total_excluded_triling<- final_data_no_exc %>%
    group_by(unique_id, exp_l1, exp_l2)%>%
   mutate(total_l1_l2_exp=(sum(exp_l1,exp_l2,na.rm = T))) %>%
  ungroup() %>%
  filter(total_l1_l2_exp<=90) %>%
  distinct(unique_id)%>%
  tally()

#Monolingual exclusions
total_monoling_excluded<- final_data %>%
  filter(exp_l1 >95) %>%
  filter(exp_l2 <5) %>%
  distinct(unique_id) %>%
  tally()


#after third language exclusions exclusions
n <- final_data %>%
  distinct(unique_id) %>%
  tally()

#subseting to get data only from each child's first visit to the lab. For main analyses
first_visit_only <- final_data_strat%>%
    arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>%
  filter(visit==1) #439 data from first visit only

#n when only taking first visit
n_keep_first_visit<-first_visit_only %>%
  distinct(unique_id)%>%
  tally()

age_min <- round(min(first_visit_only$age, na.rm = T), 2)
age_max<- round(max(first_visit_only$age, na.rm = T), 2)
age_mean<- round(mean(first_visit_only$age, na.rm = T), 2)
age_sd<- round(sd(first_visit_only$age, na.rm = T), 2)

female<- first_visit_only %>%
  filter(gender=="female")%>%
  distinct(unique_id)%>%
  tally()

twice_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==2)%>%
  distinct(unique_id)%>%
  tally()

three_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==3)%>%
  distinct(unique_id)%>%
  tally()

four_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn>3)%>%
  distinct(unique_id)%>%
  tally()


#French-English-Heritage bilingual percentages

FEH <- first_visit_only %>%
  mutate(l1 = case_when(l1=="French" ~ "French",
                        l1=="English" ~ "English",
                        TRUE ~ "Heritage")) %>%
    mutate(l2 = case_when(l2=="French" ~ "French",
                        l2=="English" ~ "English",
                        TRUE ~ "Heritage")) %>%
  mutate(bilingual_type = case_when(l1 %in% c("French", "English") & l2 %in% c("French", "English") ~ "fre-eng",
                                    l1 %in% c("French", "Heritage") & l2 %in% c("French", "Heritage") ~ "fre-her",
                                    l1 %in% c("Heritage", "English") & l2 %in% c("Heritage", "English") ~ "eng-her")) 
  
FEH_perc<- FEH %>%
  group_by(bilingual_type) %>%
  tally()%>%
    mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)


#By bilingual type percentages

fre_eng_perc <- FEH %>%
  filter(bilingual_type== "fre-eng")%>%
 group_by(l1) %>%
  tally()%>%
    mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)
  
  
  fre_her_perc <- FEH %>%
  filter(bilingual_type=="fre-her")%>%
  group_by(l1) %>%
  tally()%>%
    mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

  
  her_eng_perc <- FEH %>%
  filter(bilingual_type=="eng-her") %>%
  group_by(l1) %>%
  tally()%>%
    mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

#l1 amount of exposure range
min_exp_range <- final_data %>%
  select(exp_l1) %>%
  min()

max_exp_range <-final_data %>%
  select(exp_l1) %>%
  max()

#Prepping longitudinal data excluding irrelevant cases

longitudinal_data_analyses <- longitudinal_data %>%
  select(age, strategy, unique_id, anon_baby_id, leq_date)

longitudinal_data_analyses <- longitudinal_data %>%
  arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>% 
  mutate(first_visit_date = case_when(visit == 1 ~ leq_date)) %>%
  mutate(second_visit_date = case_when(visit == 2 ~ leq_date)) %>%
  group_by(anon_baby_id) %>%
  fill(first_visit_date, second_visit_date, .direction="updown") %>% #to collapse the rows and be able to calculate visit
  ungroup() %>%
  mutate(length_between_visits = abs(interval(start= first_visit_date, end=second_visit_date)/ duration (n=1, unit="days" ))) %>%
  filter(! length_between_visits < 15) 

#Longitudinal data set n
n_long <-longitudinal_data_analyses %>%
  distinct(unique_id)%>%
  tally()

#Longitudinal data set length between visit one and 2
visit_length<- longitudinal_data %>%
  arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>%
  filter(nn==2) %>%
  mutate(first_visit_date = case_when(visit == 1 ~ leq_date)) %>%
  mutate(second_visit_date = case_when(visit == 2 ~ leq_date)) %>%
  select(anon_baby_id, first_visit_date, second_visit_date) %>%
  group_by(anon_baby_id) %>%
  fill(first_visit_date, second_visit_date, .direction="updown") %>% #to collapse the rows and be able to calculate visit
  distinct() %>%
  ungroup() %>%
  mutate(length_between_visits = abs(interval(start= first_visit_date, end=second_visit_date)/ duration (n=1, unit="days" ))) %>%
  filter(! length_between_visits < 15) ##Filter visits that were very close together. 
##!! There is a mistake in one date which results in a negative date. Fix.


avg_visit_l <- round(mean(visit_length$length_between_visits), 2)
min_visit_l <- round(min(visit_length$length_between_visits),2)
max_visit_l <- round(max(visit_length$length_between_visits),2)
sd_visit_l <- round(sd(visit_length$length_between_visits),2)
```

  Families were contacted from a database of interested families in Montréal, Canada, largely via provincial birth lists, social media, and in-person recruitment, for example at libraries and community events. Data were collected through convenience sampling when they visited Concordia Infant Research Laboratory to participate in various studies examining bilingual language acquisition. 
  
  Our dataset consists of demographic and language exposure information collected between the years 2013 and 2020 via parental questionnaires and forms (described below). Caregivers filled out the questionnaires during each visit as part of the lab standard practice. At each visit, the infants also participated in one or more experimental tasks, and parents completed additional questionnaires, but these are not the focus of this research. All parents signed a consent form, and they were given a small thank-you gift for their participation. The current study was approved by Concordia University Human Research Ethics Board (Certification Number 10000439). 
 
 The original sample consisted of data from `r n` participants. This sample included repeated measures from some families who visited the lab twice (`r twice_visit`), three times (`r three_visit`), and four or more times (`r four_visit`). However, for our main analyses we decided to only keep one observation per family, thus we kept families who contributed data once as well as the data from the first visit of families who contributed data during multiple visits. We decided to keep data from the first visit only because that made the data from families with multiple visits and families with a single visit easier to compare. 
 
 Most infants in our data were exposed to two languages. We defined the first language (L1) as the language to which they were most exposed which ranged from `r min_exp_range`  to `r max_exp_range` in our sample, as some infants were exposed to a small amount of a third language. We therefore defined the second language (L2) as the language to which they were second most exposed. We excluded `r total_excluded_triling` children who heard more than 10% of a third language from our original sample. Because the purpose of the present study is to explore bilingual family language strategies we also excluded families whose babies were getting monolingual input defined as hearing less than 95% of their L1 or less than 5% of their L2. We excluded a total of `r total_monoling_excluded` families based on this criteria.
 
  After exclusions, the final main analyses dataset consisted of `r n_keep_first_visit` participants  aged `r age_min` to `r age_max` months (M=`r age_mean`, SD=`r age_sd`). Of whom `r female` were female. Our sample was composed of infants who heard `r fre_l1`% of French, `r eng_l1`% of English, and `r min_l1`% of a heritage language as L1; and `r fre_l2`% of which heard French, `r eng_l2`% of English and `r min_l2`% of a Heritage language as L2. A heritage language was defined as any language other than French or English. There were two reasons behind this decision. First, in Montreal, Canada, both French and English hold a majority language status, making other languages heritage or minority languages. Second, infants who heard a language other than English and French heard one of a wide variety of the following languages: Kabyle, Russian, Romanian, German, Japanese, Arabic, Tamil, Mandarin, Spanish, Italian,   Cantonese, Tagalog, Portuguese, Persian, Greek, Creole, Polish, Edo, Armenian, Hindi, Khasi, Berber, Korean, Lithuanian, Wolof, or Yoruba. Since it would have been impractical to divide the sample in so many language groups, and since those groups had few participants, we decided to collapse them into a single heritage language group.
 
  While for the main analyses we excluded the second visit data of families' who contributed data during multiple visits, we constructed a secondary longitudinal data set (n= `r n_long`) which included first and second visit data from these families. We used the longitudinal data for some descriptive analyses (described below). We however excluded the third and fourth visit data from both the main and the exploratory analyses because there were very few data points. We also excluded a second visit that occurred in less than 15 days from the first visit. The length between visits one and two varied between `r min_visit_l` and `r max_visit_l` days (m= `r avg_visit_l`days, sd= `r sd_visit_l` days).


### Instrument
  Information concerning the language environment of the infant was gathered through the Language Exposure Questionnaire (LEQ; Bosch & Sebastián-Gallés, 2001; See appendix A) following the Multilingual Approach to Language Estimates (MAPLE; Byers-Heinlein et al, 2019), in which interviewers walk caregivers through a series of questions designed to help them accurately remember and realize the language environment and exposure of their infant. 
  
  The first set of questions for the LEQ with MAPLE interview aim to understand how caregivers use their languages in daily life, particularly when talking to their infant. These questions use a likert type of scale to describe the frequency with which parents use each language when talking to their child (regularly, sometimes, or never). We used the responses from the first section of the LEQ questionnaire to characterize the family language strategy used by each family. As a reminder, parents answer the frequency with which they used each language, so the responses “regularly”, “sometimes”, “never” were given for each language. For example, for a family where both parents indicated they used both their first and second language regularly we assigned the both parents bilingual strategy. By contrast, for a family where each parent spoke a different first language regularly we assigned the one-parent-one-language strategy.  In this manner we identified four distinct strategies: both parents bilingual, one parent bilingual, one-parent-one-language, and one language at home (see Table 1). In these subcategories parents that spoke their first language regularly and never spoke another language would be categorized as strict, and parents who each spoke their first language regularly but one of them sometimes would speak another language were categorized as flexible. As we discuss further below, these two categories were ultimately collapsed into a single one-parent-one-language category. Finally, we identified a few families with a single caregiver and we characterized them as single parent families, as we didn’t have enough cases to identify distinct strategies which single parents might use.
  
  The second set of questions for the LEQ with MAPLE interview aim to give a set of estimates of the amount of time babies spend hearing each of their languages throughout their lives based on a detailed calculation made by the interviewer from caregiver responses (cumulative exposure estimate), a rough estimate made by the caregivers themselves (global exposure estimate), and an overall estimate that averages the interviewer and the caregiver estimations (overall exposure estimate). We only used data from the overall exposure estimate to determine how much exposure to each language infants in our sample were getting.
  
  The overall exposure estimate made with LEQ with MAPLE have high reliability (r = .77–.97) when compared to transcriptions of daylong home recordings, which are a direct measure of the infants’ linguistic environment (Orena et al., 2018).
  
  We additionally collected demographic information about our participants and their families via a short paper form.
  
### Data Pre-processing

  All the relevant LEQ data were manually entered from LEQ forms into excel spreadsheets. The data were entered twice by two different researchers to to catch errors, and discrepancies were resolved by a third individual who checked the original paper form. Demographic data were exported from Filemaker. 
  
  In preliminary analyses, we noticed that the one-parent-one-language strict and flexible categories both categories behaved similarly as predictors when performing statistical tests and other exploratory analyses. Moreover, splitting the categories split the sample size for the one-parent-one-language group, thus decreasing statistical power. Thus we ultimately decided to combine them into a single group. 


## Study 1: French-English data

```{r Study 1: proportion of strategy use visualizations, include=FALSE}
#Family language strategy visualization

####### FOR THE FRENCH- ENGLISH SAMPLE ############

#Calculating how many families use each strategy and its corresponding %
prop_strategy_FE<- FEH %>%
  filter(bilingual_type == "fre-eng")%>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

#Reordering levels so legend in the graph is in order.
prop_strategy_FE$strategy<- factor(prop_strategy_FE$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

prop_strategy_FE<- prop_strategy_FE %>%
 arrange(desc(prop))

#Creating dataframes of each strategy to save their percentages and print them on the text

##Both parents bilingual
both_parents_biling<- prop_strategy_FE %>%
  filter(strategy=="both-parents-bilingual") %>%
  select(perc)

perc_both_parents_biling<- round(both_parents_biling$perc, 1)

##One parent bilingual
one_parent_biling<- prop_strategy_FE %>%
  filter(strategy=="one-parent-bilingual") %>%
  select(perc)

perc_one_parents_biling<- round(one_parent_biling$perc, 1)


##One parent one lang
one_parent_one_lang<- prop_strategy_FE %>%
  filter(strategy=="one-parent-one-lang") %>%
  select(perc)

perc_one_parent_one_lang<- round(one_parent_biling$perc, 1)

##one language at home
one_language_at_home<- prop_strategy_FE %>%
  filter(strategy=="one-language-at-home") %>%
  select(perc)

perc_one_language_at_home<- round(one_parent_biling$perc, 1)


#Waffle plot
V1_FE<- setNames(prop_strategy_FE$n, c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lanaguage", "one-language-at-home", "single-parent"))

figure_1_FE<- waffle(parts = V1_FE, rows=13, colors = c(my_orange, my_yellow, my_blue, my_green, my_purple), keep = T, title = "% Family Strategies for the French-English sample", size=0.6)


#Making a figure of most used strategies divided by lang exposure
for_breakdown <- first_visit_only %>%
  mutate(l1 = case_when(l1=="French" ~ "French",
                        l1=="English" ~ "English",
                        TRUE ~ "Heritage")) %>%
group_by(strategy, l1) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

for_breakdown$strategy<- factor(for_breakdown$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

ggplot(for_breakdown, aes(x=l1, y=n, fill=strategy)) + 
  geom_bar(stat="identity", position="fill") +
  scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue, my_green, my_purple))

```



```{r Study 1: Goodness of fit analysis, include=FALSE}

for_chisq <- prop_strategy_FE %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home")) 

xsq_test<- chisq.test(for_chisq$n)

chisq_value<- round(xsq_test$statistic, 2)
chisq_p<- round(xsq_test$p.value, 4)

```



```{r Study 1: ANOVA graphs, include=FALSE}

FE_for_anova_graphs<-FEH %>%
  filter(bilingual_type == "fre-eng")

FE_for_anova_graphs$strategy<- factor(FE_for_anova_graphs$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

FE_for_anova_graphs <- FE_for_anova_graphs %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home"))
  

figure_2_a <-ggplot(FE_for_anova_graphs, aes( x=strategy , y=fre_exp, fill = strategy )) +
  stat_summary(geom="bar")+
  stat_summary() +
  ylim(0,100) +
   scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
       theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "A. Mean French exposure by strategy")

figure_2_b <-ggplot(FE_for_anova_graphs, aes( x=strategy , y=eng_exp, fill = strategy )) +
  stat_summary(geom="bar")+
  stat_summary() +
  ylim(0,100) +
   scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
       theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "B. Mean English exposure by strategy")

figure_2_c <-ggplot(FE_for_anova_graphs, aes( x=strategy , y=exp_l2, fill = strategy )) +
  stat_summary(geom="bar")+
  stat_summary() +
  ylim(0,50) +
   scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.text= element_text(size=20), legend.title= element_text(size=20))+
  labs(title= "C. Mean exposure balance by strategy")

figure_2<- figure_2_a + figure_2_b + figure_2_c 


```


```{r Study 1: ANOVA analysis, include=FALSE}

FE_for_anovas<- FEH %>%
  filter(bilingual_type == "fre-eng") %>%
  filter(!strategy == "single-parent") %>%
  filter(!strategy == "one-language-at-home") %>%
  mutate(strategy = case_when(strategy=="both-parents-bilingual"~"BothParentsBilingual",
                              strategy=="one-parent-bilingual"~"OneParentBilingual",
                              strategy=="one-parent-one-lang"~"OneParentOneLang"))
##French Anova objects

FE_anova_model_french <- aov(fre_exp ~ strategy, data= FE_for_anovas)
FE_aov_fre<- tidy(FE_anova_model_french)
FE_tukey_fre_s<- TukeyHSD (FE_anova_model_french)
FE_fre_F <- FE_aov_fre$statistic
FE_fre_p <- FE_aov_fre$p.value


##English ANOVA objects
FE_anova_model_english <- aov(eng_exp ~ strategy, data= FE_for_anovas)
FE_aov_eng<- tidy(FE_anova_model_english)
FE_tukey_eng_s<- TukeyHSD(FE_anova_model_english)


FE_eng_F <- FE_aov_eng$statistic
FE_eng_p <- FE_aov_eng$p.value

#model_performance(anova_model_english)
#check_model(anova_model_english)

## Exposure balance
FE_for_blc_anova <- FEH %>%
  filter(bilingual_type == "fre-eng")%>%
  filter(!strategy == "single-parent") %>%
    filter(!strategy == "one-language-at-home") %>%
  mutate(strategy = case_when(strategy=="both-parents-bilingual"~"BothParentsBilingual",
                              strategy=="one-parent-bilingual"~"OneParentBilingual",
                              strategy=="one-parent-one-lang"~"OneParentOneLang"))


FE_blc_model <- aov(exp_l2 ~ strategy, data= FE_for_blc_anova)
FE_aov_blc<- tidy(FE_blc_model)
FE_tukey_blc_s<- TukeyHSD(FE_blc_model)


model_performance(anova_model_french)
model_performance(anova_model_english)
model_performance(anova_model_heritage)
model_performance(blc_model)

check_model(blc_model)
check_model(anova_model_french)
check_model(anova_model_english)

plot(anova_model_french)


```


```{r Study 1: Mother and father language exploration, include=FALSE}

### Looking at the one parent bilingual data to see which parent tends to be bilingual


## In the French-English dataset ##

#Which parent is the bilingual parent?
FE_one_parent_b<- FEH %>%
  filter(bilingual_type == "fre-eng") %>%
  filter(strategy=="one-parent-bilingual") %>%
    mutate(caregiver_biling = case_when(care1_l1 %in% c("regularly", "sometimes") & care1_l2 %in% c("regularly", "sometimes") ~ "caregiver1",
                                      TRUE ~ "caregiver2"))
#What are the percentages
FE_caregiver_bi_prop <- FE_one_parent_b %>%
  group_by(caregiver_biling) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100) ## 81% mothers are the bilingual caregiver

#Which languages are spoken by the monolingual parent

monoling_careg_lang<- FE_one_parent_b %>%
  mutate(monolingual_care_lang = case_when(caregiver_biling == "caregiver1" & care2_l1 %in% c("regularly", "sometimes") ~ l1,
                                           caregiver_biling == "caregiver1" & care2_l2 %in% c("regularly", "sometimes") ~ l2,
                                           caregiver_biling == "caregiver2" & care1_l1 %in% c("regularly", "sometimes") ~l1,
                                           caregiver_biling == "caregiver2" & care1_l2 %in% c("regularly", "sometimes") ~l2)) %>%
  group_by(monolingual_care_lang) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100) ## 69% on the parents who are monolingual speak English
                                    
  

##Also looking at OPOL to see who speaks French

opol_b <- first_visit_only %>%
  filter(strategy=="one-parent-one-lang") %>%
  mutate(who_speaks_fre = case_when(l1=="French" & care1_l1 %in% c("regularly", "sometimes") ~ "mother",
                                    l1=="French" & care2_l1 %in% c("regularly", "sometimes")~"father",
                                    l2=="French" & care1_l2 %in% c("regularly", "sometimes")~"mother",
                                    l2=="French" & care2_l2 %in% c("regularly", "sometimes")~"father",
                                    TRUE ~ "English-heritage")) %>%
  mutate(bilingual_type = case_when(l1 %in% c("French", "English") & l2 %in% c("French", "English") ~ "fre-eng",
                                    l1 %in% c("French", "Heritage") & l2 %in% c("French", "Heritage") ~ "fre-her",
                                    l1 %in% c("Heritage", "English") & l2 %in% c("Heritage", "English") ~ "eng-her")) 

opol_b_fre_count <- opol_b %>%
  filter(bilingual_type=="fre-eng")%>%
  group_by(who_speaks_fre)%>%
  tally()%>%
  mutate(prop = n/sum(n))

##Looking at the responses distribution between mothers and fathers

########################## FRENCH DATA ##################
F_l1 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy)) %>%
  filter(l1=="French") %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

F_l2 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy)) %>%
  filter(l2=="French") %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

#Plotting mothers distribution of French use as L1
F_l1$care1_l1<- factor(F_l1$care1_l1, levels= c("regularly", "sometimes", "never"))

figure_4_a<- ggplot(data = F_l1, aes(x=care1_l1, fill= care1_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of French as L1", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Mothers' French as L1 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "A. Mothers' use of French as L1 by strategy")

#Plotting mothers distribution of French use as L2
F_l2$care1_l2<- factor(F_l2$care1_l2, levels= c("regularly", "sometimes", "never"))

figure_4_b<- F_l2 %>%
  filter(!care1_l2 == "NA")%>%
  ggplot(aes(x=care1_l2, fill= care1_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy)) +
  scale_fill_manual (name = "Frequency use of French as L2", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Mothers' French as L2 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.text= element_text(size=20), legend.title= element_text(size=20))+
  labs(title= "B. Mothers' use of French as L2 by strategy")


#Plotting fathers distribution of French use as L1

F_l1$care2_l1<- factor(F_l1$care2_l1, levels= c("regularly", "sometimes", "never"))

figure_5_a<- ggplot(data = F_l1, aes(x=care2_l1, fill= care2_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of French as L1", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Fathers' French as L1 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "A. Fathers' use of French as L1 by strategy")

#Plotting fathers distribution of French use as L2

F_l2$care2_l2<- factor(F_l2$care2_l2, levels= c("regularly", "sometimes", "never"))

figure_5_b<- F_l2 %>%
  filter(!care2_l2 == "NA")%>%
  ggplot(aes(x=care2_l2, fill= care2_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of French as L2", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Fathers' French as L2 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.text= element_text(size=20), legend.title= element_text(size=20))+
  labs(title= "B. Fathers' use of French as L2 by strategy")


########################## ENGLISH DATA ##################
E_l1 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy)) %>%
  filter(l1=="English") %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

E_l2 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy)) %>%
  filter(l2=="English") %>%
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

#Plotting mothers distribution of English use as L1
E_l1$care1_l1<- factor(E_l1$care1_l1, levels= c("regularly", "sometimes", "never"))

figure_4_c<- ggplot(data = E_l1, aes(x=care1_l1, fill= care1_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of English as L1", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Mothers' English as L1 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "C. Mothers' use of English as L1 by strategy")

#Plotting mothers distribution of English use as L2
E_l2$care1_l2<- factor(E_l2$care1_l2, levels= c("regularly", "sometimes", "never"))

figure_4_d<- E_l2 %>%
  filter(!care1_l2 == "NA")%>%
  ggplot(aes(x=care1_l2, fill= care1_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy)) +
  scale_fill_manual (name = "Frequency use of English as L1", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Mothers' English as L2 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "D. Mothers' use of English as L2 by strategy")



#Plotting fathers distribution of English use as L1

E_l1$care2_l1<- factor(E_l1$care2_l1, levels= c("regularly", "sometimes", "never"))

figure_5_c<- ggplot(data = E_l1, aes(x=care2_l1, fill= care2_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of English as L1", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
   xlab("Fathers' English as L1 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "C. Fathers' use of English as L1 by strategy")


#Plotting fathers' distribution of French use as L2
E_l2$care2_l2<- factor(E_l2$care2_l2, levels= c("regularly", "sometimes", "never"))

figure_5_d<- E_l2 %>%
  filter(!care2_l2 == "NA")%>%
  ggplot(aes(x=care2_l2, fill= care2_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))+
  scale_fill_manual (name = "Frequency use of English as L2", values = c("#2c7fb8","#7fcdbb", "#edf8b1")) +
  theme_bw() +
  xlab("Fathers' English as L2 use")+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "D. Fathers' use of English as L2 by strategy")


#Constructing mother and father figures of language use distribution

figure_5<- figure_5_a+figure_5_b+figure_5_c+figure_5_d
figure_4<- figure_4_a+figure_4_b+figure_4_c+figure_4_d

```


```{r Study 1: beta model graphs, include=FALSE}

figure_3_a <-ggplot(FE_for_anova_graphs, aes( x=age , y=fre_exp, color=strategy)) +
  geom_smooth(alpha=0.2)+
  scale_color_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
  ylim(0, 100)+
       theme(axis.text.x = element_text(size=20), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "A. French exposure changes by age/strategy")

figure_3_b <-ggplot(FE_for_anova_graphs, aes( x=age , y=eng_exp, color=strategy)) +
  geom_smooth(alpha=0.2)+
  scale_color_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
  ylim(0, 100)+
       theme(axis.text.x = element_text(size=20), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.position = "none")+
  labs(title= "B. English exposure changes by age/strategy")

figure_3_c <-ggplot(FE_for_anova_graphs, aes( x=age , y=exp_l2, color=strategy )) +
  geom_smooth(alpha=0.2)+
  scale_color_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue)) +
  theme_bw() +
  ylim(0, 50)+
       theme(axis.text.x = element_text(size=20), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=20), legend.text= element_text(size=20),legend.title= element_text(size=20))+
  labs(title= "C. Exposure balance changes by age/strategy")


figure_3<- figure_3_a + figure_3_b + figure_3_c

ggsave(file="Figure_3.png", width=25, height=7, dpi=300)
```


```{r Study 1: beta model analysis, include=FALSE}

# Create the dataframes to run the models for each language. Monolinguals are excluded, as are the rows 
# where exposure for a given language equals 100. Since exposure is on a 0-100 scale and the beta distributions 
# works with values ranging from 0-1, exposure is divided by 100. 




for_beta <- FE_for_anovas %>% 
  select(gender, anon_baby_id, age, fre_exp, eng_exp, strategy, care1_l1, care1_l2, care2_l1, care2_l2, l1, l2) %>% 
  mutate(caregiver_1_french_use = case_when(l1=="French"~care1_l1,
                                            l2=="French"~care1_l2))%>%
  mutate(caregiver_1_french_use = case_when(caregiver_1_french_use == "regularly" ~3,
                                            caregiver_1_french_use == "sometimes"~ 2,
                                            caregiver_1_french_use == "never"~1))%>%
  
    mutate(caregiver_1_english_use = case_when(l1=="English"~care1_l1,
                                            l2=="English"~care1_l2)) %>%

  mutate(caregiver_1_english_use = case_when(caregiver_1_english_use == "regularly" ~3,
                                            caregiver_1_english_use == "sometimes"~ 2,
                                            caregiver_1_english_use == "never"~1)) %>%

    mutate(caregiver_2_french_use = case_when(l1=="French"~ care2_l1,
                                            l2=="French"~ care2_l2)) %>%
    
  mutate(caregiver_2_french_use = case_when(caregiver_2_french_use == "regularly" ~3,
                                            caregiver_2_french_use == "sometimes"~ 2,
                                            caregiver_2_french_use == "never"~1))%>%
  
    mutate(caregiver_2_english_use = case_when(l1=="English"~care2_l1,
                                            l2=="English"~care2_l2)) %>%

  mutate(caregiver_2_english_use = case_when(caregiver_2_english_use == "regularly" ~3,
                                            caregiver_2_english_use == "sometimes"~ 2,
                                            caregiver_2_english_use == "never"~1))%>%
  
  filter(gender != "NA") %>%
  filter(!strategy == "OneLanguageAtHome")

for_beta_blc <- FE_for_blc_anova %>% 
  select(gender, anon_baby_id, age, exp_l2, strategy, care1_l1, care2_l1, care1_l2, care2_l2) %>% 
  filter(gender != "NA") %>%
    filter(!strategy == "OneLanguageAtHome")


# Dataframe for english exposure
for_beta_eng <- for_beta %>% 
  select(age, eng_exp, strategy, anon_baby_id, caregiver_1_french_use, caregiver_1_english_use, caregiver_2_french_use,caregiver_2_english_use) %>% 
  filter(eng_exp != "NA") %>% 
  mutate(eng_exp = eng_exp/100,
         strategy = as.factor(strategy)) %>%
  drop_na()

# Dataframe for french exposure
for_beta_fre <- for_beta %>% 
  select(age, fre_exp, strategy, anon_baby_id, caregiver_1_french_use, caregiver_1_english_use, caregiver_2_french_use, caregiver_2_english_use) %>%
  filter(fre_exp != "NA") %>% 
  mutate(fre_exp = fre_exp/100, 
         strategy = as.factor(strategy)) %>%
  drop_na()


#Dataframe for balance
for_balance<- for_beta_blc%>% 
  select(age, exp_l2, strategy, anon_baby_id) %>%
  filter(exp_l2 != "NA") %>% 
  mutate(exp_l2 = exp_l2/100,
         strategy = as.factor(strategy))

#Constructing the different beta models

#STRATEGY MODELS
strat_eng<- glmmTMB(eng_exp ~ strategy, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ strategy)
strat_fre <- glmmTMB(fre_exp ~ strategy, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ strategy)
strat_blc<- glmmTMB(exp_l2 ~ strategy, data=for_balance, family= beta_family(link="logit"), dispformula = ~ strategy)


#Summary of STRATEGY models
summary(strat_eng)
summary(strat_fre)
summary(strat_blc)

#AGE MODELS

#just age models
just_age_eng<- glmmTMB(eng_exp ~ age, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~  age)
just_age_fre<- glmmTMB(fre_exp ~ age, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~  age)
just_age_blc<- glmmTMB(exp_l2 ~ age, data=for_balance, family= beta_family(link="logit"), dispformula = ~  age)

#Summary of just age AGE models
summary(just_age_eng)
summary(just_age_fre)
summary(just_age_blc)

#age plus strategy models
age_plus_eng<- glmmTMB(eng_exp ~ age + strategy, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~  age + strategy)
age_plus_fre<- glmmTMB(fre_exp ~ age + strategy, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~  age + strategy)
age_plus_blc<- glmmTMB(exp_l2 ~ age + strategy, data=for_balance, family= beta_family(link="logit"), dispformula = ~  age + strategy)

#Summary of just age AGE models
summary(age_plus_eng)
summary(age_plus_fre)
summary(age_plus_blc)

#age by strategy models
age_by_eng<- glmmTMB(eng_exp ~ age * strategy, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~  age * strategy)
age_by_fre<- glmmTMB(fre_exp ~ age * strategy, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~  age * strategy)
age_by_blc<- glmmTMB(exp_l2 ~ age * strategy, data=for_balance, family= beta_family(link="logit"), dispformula = ~  age * strategy)

#Summary of just age AGE models
summary(age_by_eng)
summary(age_by_fre)
summary(age_by_blc)

#Contrasting of age models




#MOTHER MODELS
mom_beta_eng<- glmmTMB(eng_exp ~ caregiver_1_english_use, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ caregiver_1_english_use)
mom_beta_fre<- glmmTMB(fre_exp ~ caregiver_1_french_use, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ caregiver_1_french_use)

#Summary of MOTHER models
summary(mom_beta_eng)
summary(mom_beta_fre)


#FATHER MODELS 
dad_beta_eng<- glmmTMB(eng_exp ~ caregiver_2_english_use, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ caregiver_2_english_use)
dad_beta_fre<- glmmTMB(fre_exp ~ caregiver_2_french_use, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ caregiver_2_french_use)

#Summary of FATHER models
summary(dad_beta_eng)
summary(dad_beta_fre)


#MOTHER AND FATHER MODELS
parents_aditive_eng<- glmmTMB(eng_exp ~ caregiver_2_english_use + caregiver_1_english_use, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ caregiver_2_english_use + caregiver_1_english_use)

parents_aditive_fre<- glmmTMB(fre_exp ~ caregiver_2_french_use + caregiver_1_french_use, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ caregiver_2_french_use + caregiver_1_french_use)

parents_aditive_blc<- glmmTMB(exp_l2 ~ caregiver_2_french_use + caregiver_1_french_use, data=for_balance, family= beta_family(link="logit"), dispformula = ~ caregiver_2_french_use + caregiver_1_french_use)

parents_int_eng<- glmmTMB(eng_exp ~ caregiver_2_english_use * caregiver_1_english_use, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ caregiver_2_english_use * caregiver_1_english_use)

parents_int_fre<- glmmTMB(fre_exp ~ caregiver_2_french_use * caregiver_1_french_use, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ caregiver_2_french_use * caregiver_1_french_use)

parents_int_blc<- glmmTMB(exp_l2 ~ caregiver_2_french_use * caregiver_1_french_use, data=for_balance, family= beta_family(link="logit"), dispformula = ~ caregiver_2_french_use * caregiver_1_french_use)


#Summary of PARENTS models
summary(parents_aditive_eng)
summary(parents_aditive_fre)
summary(parents_aditive_blc)
summary(parents_int_eng)
summary(parents_int_fre)
summary(parents_int_blc)



## MODEL COMPARISONS
#ENGLISH MODELS
test_performance(parents_int_eng, parents_aditive_eng, mom_beta_eng)
test_performance(parents_int_eng, parents_aditive_eng, dad_beta_eng)
performance::compare_performance(parents_int_eng, parents_aditive_eng, mom_beta_eng, dad_beta_eng)

## Model comparison

#low root mean square error is better, high R2 is betterm low AIC and BIC is better
performance::compare_performance(parents_int_eng, strat_eng) #parents use is the better model



#predicting models' effects

beta_eng_effects <- ggpredict(beta_eng, terms = c("age", "strategy"))
beta_fre_effects <- ggpredict(beta_fre, terms = c("age", "strategy"))
beta_min_effects <- ggpredict(beta_min, terms = c("age", "strategy"))
beta_blc_effects <- ggpredict(beta_blc, terms = c("age", "strategy"))


```

## Study 2

```{r}
###### FOR THE FRENCH- HERITAGE SAMPLE ###########
#Calculating how many families use each strategy and its corresponding %
prop_strategy_FH<- FEH %>%
  filter(bilingual_type == "fre-her")%>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

#Reordering levels so legend in the graph is in order.
prop_strategy_FH$strategy<- factor(prop_strategy_FH$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

prop_strategy_FH<- prop_strategy_FH %>%
 arrange(desc(prop))

#Waffle plot
V1_FH<- setNames(prop_strategy_FH$n, c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lanaguage", "one-language-at-home", "single-parent"))

figure_1_FH<- waffle(parts = V1_FH, rows=5, colors = c(my_orange, my_yellow, my_blue, my_green, my_purple), keep = T, title = "% Family Strategies for the French-heritage sample", size=0.6)


##### FOR THE ENGLISH- HERITAGE SAMPLE ###########
prop_strategy_EH<- FEH %>%
  filter(bilingual_type == "eng-her")%>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

#Reordering levels so legend in the graph is in order.
prop_strategy_EH$strategy<- factor(prop_strategy_EH$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

prop_strategy_EH<- prop_strategy_EH %>%
 arrange(desc(prop))

#Waffle plot
V1_EH<- setNames(prop_strategy_EH$n, c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lanaguage", "single-parent"))

figure_1_EH<- waffle(parts = V1_EH, rows=5, colors = c(my_orange, my_yellow, my_blue, my_green, my_purple), keep = T, title = "% Family Strategies for the English-heritage sample", size=0.6)
```


```{r Study 2}



########################## HERITAGE DATA ##################
H_l1 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy, bilingual_type)) %>%
  filter(!bilingual_type == "fre-eng") %>%
  filter(!l1 %in% c("French", "English"))
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

H_l2 <- FEH %>%
select(c(unique_id, l1, exp_l1, l2, exp_l2, care1_l1, care1_l2, care2_l1, care2_l2, strategy, bilingual_type)) %>%
  filter(!bilingual_type == "fre-eng") %>%
  filter(!l2 %in% c("French", "English"))
  filter(!strategy %in% c("single-parent", "one-language-at-home"))

#Plotting mothers distribution of English use as L1
ggplot(data = H_l1, aes(x=care1_l1, fill= care1_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))

#Plotting mothers distribution of French use as L2
H_l2 %>%
  filter(!care1_l2 == "NA")%>%
  ggplot(aes(x=care1_l2, fill= care1_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))


#Plotting fathers distribution of French use as L1

ggplot(data = E_l1, aes(x=care2_l1, fill= care2_l1)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))

#Plotting mothers distribution of French use as L2
E_l2 %>%
  filter(!care2_l2 == "NA")%>%
  ggplot(aes(x=care2_l2, fill= care2_l2)) +
  geom_bar() +
  facet_grid(cols = vars(strategy))


```


## Longitudinal exploratory analyses
  
```{r, include=FALSE}
## LONGITUDINAL DATA ANALYSES ##

########### Count proportions ##########

v1_strat_prop <- longitudinal_data_analyses %>%
  select(visit, strategy) %>%
  filter(visit==1) %>%
  filter(!strategy == "single-parent") %>%
  group_by(strategy) %>%
  tally()%>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)


v2_strat_prop <- longitudinal_data_analyses %>%
  select(visit, strategy) %>%
  filter(visit==2) %>%
  filter(!strategy == "single-parent") %>%
  group_by(strategy) %>%
  tally()%>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

percentages_visits <- merge(v1_strat_prop, v2_strat_prop, by="strategy")

percentages_visits <- percentages_visits %>%
  select(strategy, n.x, n.y, perc.x, perc.y) %>%
  rename(n_first_visit = n.x) %>%
  rename(n_second_visit = n.y) %>%
  rename(percentage_first_visit = perc.x) %>%
  rename(percentage_second_visit = perc.y)

perc_family_change <- longitudinal_data_analyses %>%
  select(visit, strategy, anon_baby_id) %>%
  filter(visit == c(1,2)) %>%
  filter(!strategy == "single-parent") %>%
  pivot_wider(names_from = visit, values_from = strategy) %>%
  rename(visit_1 = "1") %>%
  rename(visit_2 = "2") %>%
  mutate(change_strat = case_when(visit_1 == visit_2 ~"no_change",
                                  TRUE~ "change")) %>%
  group_by(change_strat) %>%
  tally() %>%
  mutate(perc = (n/sum(n)*100))

change_perc<- perc_family_change %>%
  filter(change_strat == "change") 

change_perc <- change_perc$perc
  
no_change_perc<- 100-change_perc

###########################

###################### GLMER MODEL To learn weather changing strategy was related to the time between visits ########

for_long_glmer<- longitudinal_data_analyses %>%
    select(visit, strategy, length_between_visits, anon_baby_id) %>%
  filter(visit == c(1,2)) %>%
  filter(!strategy == "single-parent") %>%
  pivot_wider(names_from = visit, values_from = strategy) %>%
  rename(visit_1 = "1") %>%
  rename(visit_2 = "2") %>%
  mutate(change_strat = case_when(visit_1 == visit_2 ~"no_change",
                                  TRUE~ "change"))
  

long_model<- glmer(as.factor(change_strat) ~ scale(length_between_visits) +(1|anon_baby_id), data = for_long_glmer, family="binomial")

summary(long_model)




############ make sankey graph ########

wider_longitudinal <- longitudinal_data_analyses %>%
  select(anon_baby_id, visit, strategy) %>%
  filter(str_detect(strategy, "single-parent", negate=T))

wider_longitudinal <- pivot_wider(wider_longitudinal,
                                names_from = visit, values_from = strategy ) %>%
  rename(visits_1 = "1", visits_2 = "2", visit_3 ="3", visit_4 ="4" ) 



for_sankey <- wider_longitudinal %>%
  make_long(visits_1, visits_2) 

for_sankey <- for_sankey %>%
  mutate(node= fct_relevel (node, "both-parents-bilingual", "one-parent-bilingual", "one-language-at-home", "one-parent-one-language"))


p1<- ggplot(for_sankey, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node), label=node )) +
  geom_sankey() 

p2<- p1+ 
      scale_fill_manual(name= "x", values = c(my_orange, my_yellow, my_green, my_blue))

p2<- p2 + 
  geom_sankey_label(size=3, color="black", fill="white")+
  theme_bw()+
  theme(legend.position = "none", axis.ticks = element_blank(), axis.text.y = element_blank()) +
  labs(title="Stability of Family Strategies Across Visits", x="")
  

```
  Finally, we wanted to explore whether families switched in their use of family language strategies across time. To explore this, we used a subset of our data that included families that had provided LEQ data two separate visits (i.e. longitudinal data). We plotted the longitudinal data (See Figure 3) to determine the stability of family strategy use across time. As can be observed, most families maintain the same family language strategy throughout both visits. Specifically, `r no_change_perc`% kept the same strategy, and `r change_perc`% changed strategies  (See Table 5 for the breakdown of strategy use by visit). The biggest gain between visits was for the both parents bilingual strategy which gained around 6%. The biggest loss between visits was for the one language at home strategy which lost around 5%. The most common change between strategies was from the one parent bilingual strategy, to the both parents bilingual strategy, followed by changing from the one language at home strategy to the one parent bilingual strategy.  


  Figure 4
  
```{r echo=FALSE}
print(p2)
```

Table 5 Percentage of Family Strategy Use in Each Visit

```{r echo=FALSE}

kable(percentages_visits)
```

  
```{r}

## Extra code

######## FOR THE WHOLE SAMPLE ############

#Calculating how many families use each strategy and its corresponding %
prop_strategy<- first_visit_only %>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

#Reordering levels so legend in the graph is in order.
prop_strategy$strategy<- factor(prop_strategy$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

prop_strategy<- prop_strategy %>%
 arrange(desc(prop))

#Creating dataframes of each strategy to save their percentages and prnt them on the text

##Both parents bilingual
both_parents_biling<- prop_strategy %>%
  filter(strategy=="both-parents-bilingual") %>%
  select(perc)

perc_both_parents_biling<- round(both_parents_biling$perc, 1)

##One parent bilingual
one_parent_biling<- prop_strategy %>%
  filter(strategy=="one-parent-bilingual") %>%
  select(perc)

perc_one_parents_biling<- round(one_parent_biling$perc, 1)


##One parent one lang
one_parent_one_lang<- prop_strategy %>%
  filter(strategy=="one-parent-one-lang") %>%
  select(perc)

perc_one_parent_one_lang<- round(one_parent_biling$perc, 1)

##one language at home
one_language_at_home<- prop_strategy %>%
  filter(strategy=="one-language-at-home") %>%
  select(perc)

perc_one_language_at_home<- round(one_parent_biling$perc, 1)


#Waffle plot
V1<- setNames(prop_strategy$n, c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lanaguage", "one-language-at-home", "single-parent"))

figure_1<- waffle(parts = V1, rows=20, colors = c(my_orange, my_yellow, my_blue, my_green, my_purple), keep = T, title = "Proportion of Use of Family Strategies", size=0.6)


#Making a figure of most used strategies divided by lang exposure
for_breakdown <- first_visit_only %>%
  mutate(l1 = case_when(l1=="French" ~ "French",
                        l1=="English" ~ "English",
                        TRUE ~ "Heritage")) %>%
group_by(strategy, l1) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

for_breakdown$strategy<- factor(for_breakdown$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

ggplot(for_breakdown, aes(x=l1, y=n, fill=strategy)) + 
  geom_bar(stat="identity", position="fill") +
  scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue, my_green, my_purple))


#collapse_rows_df <- function(df, variable){
 #group_var <- enquo(variable)
  #df %>%
   # group_by(!! group_var) %>%
    #mutate(groupRow = 1:n()) %>%
    #ungroup() %>%
    #mutate(!!quo_name(group_var) := ifelse(groupRow == 1, as.character(!! group_var), "")) %>%
    #select(-c(groupRow))
#}

#strats_table<- final_data_strat %>%
 # select(c(strategy, care1_l1, care1_l2, care2_l1, care2_l2))%>%
  #rename(caregiver_A_L1 = care1_l1)%>%
  #rename(caregiver_A_L2 = care1_l2)%>%
  #rename(caregiver_B_L1 = care2_l1)%>%
  #rename(caregiver_B_L2 = care2_l2)%>%
  #arrange(strategy) %>%
  #distinct() %>%
  #collapse_rows_df(strategy)


#color_formatter <- formatter(
 # "span",
#  style = x ~ style(
 #   color = 'black',
  #  'background-color' =
   #   ifelse(x == "regularly", "#a1d76a", ifelse( x=="sometimes","#ffffbf", if_else(x=="never", "#e9a3c9", "white")))
    #        ))

 #formattable(strats_table,
  #          list(
   #           `caregiver_A_L1`= color_formatter,
    #          `caregiver_A_L2`= color_formatter,
     #         `caregiver_B_L1`= color_formatter,
      #        `caregiver_B_L2`= color_formatter
       #     )) %>%
    #as.datatable(options = list(pageLength = 35)) %>%
  #spk_add_deps() -> w

#htmlwidgets::saveWidget(w, "table.html", selfcontained = TRUE)
#webshot::webshot(url = "table.html", file = "table.png", 
 #              vwidth = 1200, vheight = 275)

```

