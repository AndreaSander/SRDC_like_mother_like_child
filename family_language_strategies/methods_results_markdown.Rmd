---
title: "results_markdown"
author: "ASM"
date: "13/01/2023"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data call in, include=FALSE}
library(formattable)
library(here)
library(lme4)
library(lmerTest)
library(rstatix)
library(papeR)
library(knitr)
library(waffle)
library(ggsankey)
library(dplyr)
library(tidyverse)
load(here("anonymized_data/final_merged_data.Rda"))
load(here("anonymized_data/final_data_no_exc.Rda"))
load(here("anonymized_data/final_data_strat.Rda"))
load(here("anonymized_data/longitudinal_data.Rda"))

```

## Methods

### Participants
```{r participants information, include=FALSE}
#### CONSTRUCTING AND DESCRIBING ALL RELEVANT DATA SETS ####

#Exclusions count
total_excluded<- final_data_no_exc %>%
    group_by(unique_id, exp_l1, exp_l2)%>%
   mutate(total_l1_l2_exp=(sum(exp_l1,exp_l2,na.rm = T))) %>%
  ungroup() %>%
  filter(total_l1_l2_exp<=90) %>%
  distinct(unique_id)%>%
  tally()

#after third language exclusions exclusions
n <- final_data %>%
  distinct(unique_id) %>%
  tally()

#subseting to get data only from each child's first visit to the lab. For main analyses
first_visit_only <- final_data_strat%>%
    arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>%
  filter(visit==1) #439 data from first visit only

#n when only taking first visit
n_keep_first_visit<-first_visit_only %>%
  distinct(unique_id)%>%
  tally()

age_min <- round(min(first_visit_only$age, na.rm = T), 2)
age_max<- round(max(first_visit_only$age, na.rm = T), 2)
age_mean<- round(mean(first_visit_only$age, na.rm = T), 2)
age_sd<- round(sd(first_visit_only$age, na.rm = T), 2)

female<- first_visit_only %>%
  filter(gender=="female")%>%
  distinct(unique_id)%>%
  tally()

twice_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==2)%>%
  distinct(unique_id)%>%
  tally()

three_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==3)%>%
  distinct(unique_id)%>%
  tally()

four_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn>3)%>%
  distinct(unique_id)%>%
  tally()

#Longitudinal data set n
n_long <-longitudinal_data %>%
  distinct(unique_id)%>%
  tally()

```

  Participants were recruited through convenience sampling when they visited Concordia Infant Research Laboratory to participate in a study. Families were contacted from a database of interested families in Montréal, Canada, largely via provincial birth lists, social media, and in-person recruitment, for example at libraries and community events.
  Our data consists of demographic and language exposure information collected between the years 2013 and 2020 via parental questionnaires and forms (described below). Caregivers filled out the questionnaires during each visit as part of the lab standard practice. At each visit, the infants also participated in several different experimental tasks, but these are not the focus of this research. All parents signed a consent form, and they were given a small thank-you gift for their participation. The current study was approved by Concordia University Human Research Ethics Board (Certification Number 10000439). 
 
 The original sample consisted of data from `r n` participants. This sample included repeated measures from some families who visited the lab twice (`r twice_visit`), three times (`r three_visit`), and four or more times (`r four_visit`). However, for our main analyses we decided to only keep one observation per family, thus We kept families who contributed data once as well as the data from the first visit of families who contributed data during multiple visits. The final data thus consisted of `r n_keep_first_visit` participants  aged `r age_min` to `r age_max` (M=`r age_mean`, SD=`r age_sd`). Of whom `r female` were female. We further excluded `r total_excluded` children who heard more than 10% of a third language.
 
 While for the main analyses we excluded the second visit data of families' who came to multiple visits, we constructed a secondary data set (n= `r n_long`) which included first and second visit data from families who contributed data during multiple visits. We used this secondary data set to explore and describe our longitudinal data. We however excluded the third and fourth visit data from both the main and the exploratory analyses because there were very few data points (). 

### Instrument
  Information concerning the language environment of the infant was gathered through the Language Exposure Questionnaire (LEQ; Bosch & Sebastián-Gallés, 2001; See appendix A) following the Multilingual Approach to Language Estimates (MAPLE; Byers-Heinlein et al, 2019), in which interviewers walk caregivers through a series of questions designed to help them accurately remember and realize the language environment and exposure of their infant. 
  
  The first set of questions for the LEQ with MAPLE interview aim to understand how caregivers use their languages in daily life, particularly when talking to their baby. These questions use a likert type of scale to describe the frequency with which parents use each language when talking to their child (regularly, sometimes, or never). These first set of questions helped us determine the family language strategies, for example if a caregiver uses French regularly and never uses English while the other caregiver does the opposite, we assume they are using a one-parent-one-language strategy.
  
  The first set of questions for the LEQ with MAPLE interview aim to give a set of estimates of the amount of time babies spend hearing each of their languages throughout their lives based on a calculation made by the interviewer from caregiver responses (overall estimate), a rough estimate based on an estimation by the caregivers themselves (xxx estimate), and an overall estimate that averages the interviewer and the caregiver estimations (global estimate). The exposure estimates made with LEQ with MAPLE have high reliability (r = .77–.97) when compared to transcriptions of daylong home recordings, which are a direct measure of the infants’ linguistic environment (Orena et al., 2018).
  We additionally collected demographic information about our participants and their families via a short paper form.


## Results 

```{r table describing the family strategies categorization}

collapse_rows_df <- function(df, variable){
 group_var <- enquo(variable)
  df %>%
    group_by(!! group_var) %>%
    mutate(groupRow = 1:n()) %>%
    ungroup() %>%
    mutate(!!quo_name(group_var) := ifelse(groupRow == 1, as.character(!! group_var), "")) %>%
    select(-c(groupRow))
}

strats_table<- final_data_strat %>%
  select(c(strategy, care1_l1, care1_l2, care2_l1, care2_l2))%>%
  rename(caregiver_A_L1 = care1_l1)%>%
  rename(caregiver_A_L2 = care1_l2)%>%
  rename(caregiver_B_L1 = care2_l1)%>%
  rename(caregiver_B_L2 = care2_l2)%>%
  arrange(strategy) %>%
  distinct() %>%
  collapse_rows_df(strategy)


color_formatter <- formatter(
  "span",
  style = x ~ style(
    color = 'black',
    'background-color' =
      ifelse(x == "regularly", "#a1d76a", ifelse( x=="sometimes","#ffffbf", if_else(x=="never", "#e9a3c9", "white")))
            ))
            
table_1<- formattable(strats_table,
            list(
              `caregiver_A_L1`= color_formatter,
              `caregiver_A_L2`= color_formatter,
              `caregiver_B_L1`= color_formatter,
              `caregiver_B_L2`= color_formatter
            ))


            
            
```


### Data Pre-Processing

  All the relevant LEQ data were manually entered from LEQ forms into excel spreadsheets. The data were entered twice by two different researchers to to catch errors, and discrepancies were resolved by a third individual who checked the original paper form. Demographic data were exported from Filemaker. 
  
  We used the responses from the first section of the LEQ questionnaire to characterize the family language strategy used by each family. For example, for a family where both parents indicated they used both their first and second language regularly we assigned the both parents bilingual strategy. Whereas for a family where each parent spoke a different first language regularly we assigned the one-parent-one-language strategy. In this manner we identified four distinct strategies: both parents bilingual, one parent bilingual, one-parent-one-language, and one language at home (see Table 1). We had originally sub-divided the one-parent-one-language strategy into a strict and flexible categories. In these sub-categories parents that always spoke their first language regularly and never spoke another language would be categorized as strict, and parents who always spoke their first language regularly but sometimes would speak another language were categorized as flexible. However, we noticed both categories were indistinct when performing statistical tests and other exploratory analyses, and thus we ultimately decided to keep them as a single group. Finally, we identified a few families with a single caregiver and we characterized them as single parent families, as we didn't have enough cases to identify distinct strategies which single parents might use.

Table 1.
```{r print table x, include=FALSE}

print(table_1)

```



```{r proportion of strategy use visualizations, include=FALSE}
#Family language strategy visualization


#Calculating how many families use each strategy and its corresponding %
prop_strategy<- first_visit_only %>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

both_parents_biling<- prop_strategy %>%
  filter(strategy=="both-parents-bilingual") %>%
  select(perc)

perc_both_parents_biling<- round(both_parents_biling$perc, 1)

prop_strategy<- prop_strategy %>%
 arrange(desc(prop))

#Waffle plot

figure_1<- ggplot(prop_strategy, aes(fill=strategy, values= n, na.rm=T)) +
  geom_waffle (n_rows=22, color="white")+
  scale_fill_manual (name = "Family Strategy", values =c("#FFC107", "#d95f02", "#1f78b4", "#33a02c", "#7570b3" )) +
 labs(x="", title = "Proportion of Use of Family Strategies")+
theme(axis.text.x= element_blank(), axis.ticks = element_blank())+
 coord_equal()+
theme_void() 


```
### Analytic approach
  We first described the family strategies (See Figure 1). The most common strategy was the both parents bilingual strategy which represented `r perc_both_parents_biling`% of the sample.

Figure 1
```{r, echo=FALSE}
print(figure_1)
```

```{r goodness of fit, include=FALSE}
for_chisq <- prop_strategy %>%
  filter(strategy=="single-parent") # filter single parents because the cell size is small

xsq_test<- chisq.test(prop_strategy$n)

chisq_value<- round(xsq_test$statistic, 2)
chisq_p<- round(xsq_test$p.value, 4)
```

  We performed a chi-square goodness of fit test to determine weather the difference in proportion of usage between strategies was statistically significant, where the null hypothesis is that the strategies are used in the same proportion across the families tested. The chi-squared goodness of test revealed a statistically significant difference between the distribution of proportions in our data and a distribution in which all the proportions are equal (X= `r chisq_value`, p= <.001).
  We were also interested in weather the mean exposure to the majority languages French and English, and the mean exposure to a minority language changed as a function of which family language strategy was used (Figure 2)
```{r, include=FALSE}

fre_by_strategy <- first_visit_only  %>%
  select(c(strategy, fre_exp)) %>%
  group_by(strategy) %>%
  dplyr::summarize(mean(fre_exp))

figure_2_a <-ggplot(fre_by_strategy, aes( x=strategy , y=`mean(fre_exp)`, fill = strategy )) +
  geom_col() +
   scale_fill_manual (name = "Family Strategy", values =c("#1f78b4", "#d95f02","#FFC107","#b2df8a","#33a02c", "#7570b3")) +
  theme(axis.text.x = element_text(angle = 25))+
  theme_bw() +
  labs(title= "Mean french exposure by strategy")

eng_by_strategy <- first_visit_only  %>%
  select(c(strategy, eng_exp)) %>%
  group_by(strategy) %>%
  dplyr::summarize(mean(eng_exp))

figure_2_b <-ggplot(eng_by_strategy, aes( x=strategy , y=`mean(eng_exp)`, fill = strategy )) +
  geom_col() +
   scale_fill_manual (name = "Family Strategy", values =c("#1f78b4", "#d95f02","#FFC107","#b2df8a","#33a02c", "#7570b3")) +
  theme(axis.text.x = element_text(angle = 25))+
  theme_bw() +
  labs(title= "Mean english exposure by strategy")

min_by_strategy <- first_visit_only  %>%
  select(c(strategy, min_exp)) %>%
  group_by(strategy) %>%
  dplyr::summarize(mean(min_exp))

figure_2_c <-ggplot(min_by_strategy, aes( x=strategy , y=`mean(min_exp)`, fill = strategy )) +
  geom_col() +
   scale_fill_manual (name = "Family Strategy", values =c("#1f78b4", "#d95f02","#FFC107","#b2df8a","#33a02c", "#7570b3")) +
  theme(axis.text.x = element_text(angle = 25))+
  theme_bw() +
  labs(title= "Mean minority langauge exposure by strategy")


```

Figure 2 a)
```{r, echo=FALSE}
print(figure_2_a)
```

Figure 2 b)
```{r, echo=FALSE}
print(figure_2_b)
```


Figure 2 c)
```{r, echo=FALSE}

print(figure_2_c)
```

  
  To test this statistically, we conducted t-test pairwise comparisons to explore the relation between different family language strategies and the amount of French exposure children were getting (See Table 2). French is the majority language in the province of Quebec. We then repeated the process for amount of English exposure (See Table 3). English is not considered a majority language in the province of Quebec, but it is one of Canada's official languages and thus it holds a high linguistic status. We finally repeated the process for amount of minority language exposure (See Table 4). There are many minority languages aside from English that are spoken in the province of Quebec, however they tend to have a lower linguistic status than English.    


```{r results from t tests, include=FALSE}
#Loading results from t-test pairwise comparisons
load(here("results/t_fre.Rda"))
load(here("results/t_eng.Rda"))
load(here("results/t_min.Rda"))

t_fre<- as.data.frame(pwc_exp_fre)
t_eng<- as.data.frame(pwc_exp_eng)
t_min<- as.data.frame(pwc_exp_min)
```
###Table 2
```{r, include=FALSE}
kable(t_fre)
```
##Table 3
```{r}

kable(t_eng)

```

##Table 4
```{r}
kable(t_min)

```

  Finally, we wanted to explore weather families switched in their use of family language strategies across time.To explore this, we used a subset of of our data that included families that had provided LEQ data two separate visits (i.e. longitudinal data). As mentioned in the method section we had a few families that had contributed data to three, four or more data points, however these families were so few we decided not to include data beyond the second point. We wxplored the longitudinal data (See Figure 3) to determine thew stability of family strategy use across time.
  
```{r, include=FALSE}
#select only relevant variables
longitudinal_data <- longitudinal_data %>%
  select(age, strategy, unique_id, anon_baby_id)

longitudinal_data<- longitudinal_data %>%
  arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() 

wider_longitudinal <- longitudinal_data %>%
  select(anon_baby_id, visit, strategy) %>%
  filter(str_detect(strategy, "single-parent", negate=T))

wider_longitudinal <- pivot_wider(wider_longitudinal,
                                names_from = visit, values_from = strategy ) %>%
  rename(visit_1 = "1", visit_2 = "2", visit_3 ="3", visit_4 ="4" ) 



for_sankey <- wider_longitudinal %>%
  make_long(visit_1, visit_2) 

for_sankey <- for_sankey %>%
  mutate(node= fct_relevel (node, "both-parents-bilingual", "one-parent-bilingual", "one-language-at-home", "one-parent-one-lang-flex", "one-parent-one-lang-strict"))

p1<- ggplot(for_sankey, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node), label=node)) +
  geom_sankey() 

p2<- p1+ 
      scale_fill_manual(name= "x", values = c("#1f78b4", "#FFC107", "#d95f02","#b2df8a","#33a02c"))

p2<- p2 + 
  geom_sankey_label(size=3, color="black", fill="white")+
  theme_bw()+
  theme(legend.position = "none", axis.ticks = element_blank(), axis.text.y = element_blank()) +
  labs(title="Stability of Family Strategies Across Visit", x="")
  

```
  
  Figure 3
```{r}
print(p2)
```
  
  