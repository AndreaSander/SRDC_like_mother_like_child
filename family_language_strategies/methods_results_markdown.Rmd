---
title: "results_markdown"
author: "ASM"
date: "13/01/2023"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data call in, include=FALSE}
library(here)
library(dplyr)
library(lme4)
library(lmerTest)
library(rstatix)
library(papeR)
library(knitr)
library(waffle)
library(ggsankey)
library(tidyverse)
load(here("anonymized_data/final_merged_data.Rda"))
load(here("anonymized_data/final_data_no_exc.Rda"))
load(here("anonymized_data/final_data_strat.Rda"))
load(here("anonymized_data/longitudinal_data.Rda"))

```

## Methods

### Participants
```{r participants information, include=FALSE}
#Exclusions count
total_excluded<- final_data_no_exc %>%
    group_by(unique_id, exp_l1, exp_l2)%>%
   mutate(total_l1_l2_exp=(sum(exp_l1,exp_l2,na.rm = T))) %>%
  ungroup() %>%
  filter(total_l1_l2_exp>=90) %>%
  distinct(unique_id)%>%
  tally()

#after exclusions
n <- final_data %>%
  distinct(unique_id) %>%
  tally()

age_min <- min(final_data$age, na.rm = T)
age_max<- max(final_data$age, na.rm = T)
age_mean<- mean(final_data$age, na.rm = T)
age_sd<- sd(final_data$age, na.rm = T)

female<- final_data %>%
  filter(gender=="female")%>%
  distinct(unique_id)%>%
  tally()

twice_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==2)%>%
  distinct(unique_id)%>%
  tally()

three_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn==3)%>%
  distinct(unique_id)%>%
  tally()

four_visit <- final_data %>%
  add_count(anon_baby_id) %>%
  filter(nn>3)%>%
  distinct(unique_id)%>%
  tally()

```

 Participants for each study were recruited from a database of interested families in Montréal, Canada, largely via provincial birth lists, social media, and in-person recruitment, for example at libraries and community events. 
 
 The final sample consisted of data from `r n` participants aged `r age_min` to `r age_max` (M=`r age_mean`, SD=`r age_sd`). Of whom `r female` were female. Some participants contributed data twice at different time points (n=`r twice_visit`), three times at different time points (n=`r three_visit`), and four or more times at different time points (n=`r four_visit`). A further `r total_excluded` children contributed data but were excluded due to hearing more than 10% of a third language. There were no other exclusion criteria.

### Instrument
  Information concerning the language environment of the infant was gathered through the Language Exposure Questionnaire (LEQ; Bosch & Sebastián-Gallés, 2001; See appendix A) following the Multilingual Approach to Language Estimates (MAPLE; Byers-Heinlein et al, 2019), in which interviewers walk caregivers through a series of questions designed to help them accurately remember and realize the language environment and exposure of their infant. LEQ with MAPLE has high reliability (r = .77–.97) when compared to transcriptions of daylong home recordings, which are a direct measure of the infants’ linguistic environment (Orena et al., 2018).

### Procedure
  Families were recruited through convenience sampling and visited the Concordia Infant Research Laboratory between 2013 and 2020. Caregivers were then asked to fill out a series of questionnaires as part of the lab standard practice, one (LEQ, described above) of which was the focus of the present study. At the time, the infants also participated in different experimental studies, but these are not the focus of this research. All parents signed a consent form (Appendix B), and they were given a small thank-you gift for their participation. The current study was approved by Concordia University Human Research Ethics Board (Certification Number 10000439). 
 
## Results 

### Data Pre-Processing

  All the relevant LEQ data were manually entered from LEQ forms into excel spredsheets. The data were entered twice by two different researchers to minimize human errors. Demographic data were exported from Filemaker. LEQ and demographic data were merged together using a unique identifier per child per study, as some children participated in more than one study. 

 

```{r proportion of strategy use visualizations, include=FALSE}
#Family language strategy visualization

#subseting to get data only from each child's first visit to the lab
first_visit_only <- final_data_strat%>%
    arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>%
  filter(visit==1) #439 data from first visit only

#n when only taking first visit
n_keep_first_visit<-first_visit_only %>%
  distinct(unique_id)%>%
  tally()

#Calculating how many families use each strategy and its corresponding %
prop_strategy<- first_visit_only %>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n)) %>%
  mutate(perc= prop*100)

perc_both_parents_biling<- prop_strategy %>%
  filter(strategy=="both-parents-bilingual") %>%
  select(perc)

prop_strategy<- prop_strategy %>%
  mutate(strategy = fct_reorder(prop_strategy$strategy, prop_strategy$prop, .desc=F))

#Waffle plot

figure_1<- ggplot(prop_strategy, aes(fill=strategy, values= n, na.rm=T)) +
  geom_waffle (n_rows=22, color="white")+
  scale_fill_manual (name = "Family Strategy", values =c("#7570b3","#33a02c","#b2df8a", "#d95f02", "#FFC107", "#1f78b4")) +
 labs(x="", title = "Proportion of Use of Family Strategies")+
theme(axis.text.x= element_blank(), axis.ticks = element_blank())+
 coord_equal()+
theme_void() 


```
### Analytic approach
  We first described the family strategies (See Figure 1). The most common strategy was the both parents bilingual strategy which represented `r perc_both_parents_biling`% of the sample.

Figure 1
```{r}
print(figure_1)
```

```{r goodness of fit, include=FALSE}
for_chisq <- prop_strategy %>%
  filter(strategy=="single-parent") # filter single parents because the cell size is small

xsq_test<- chisq.test(prop_strategy$n)

chisq_value<- xsq_test$statistic
chisq_p<- xsq_test$p.value
```

  We performed a chi-square goodness of fit test to determine weather the difference in proportion of usage between strategies was statistically significant, where the null hypothesis is that the strategies are used in the same proportion across the families tested. The chi-squared goodness of test revealed a statistically significant difference between the distribution of proportions in our data and a distribution in which all the proportions are equal(X^2 = 'r chisq_value', p='r chisq_p'). 
  
  We were also interested in weather the mean exposure to the majority languages French and English, and the mean exposure to a minority language changed as a function of which family language strategy was used (Figure 2)
```{r, include=FALSE}

fre_by_strategy <- final_data_strat  %>%
  select(c(strategy, fre_exp)) %>%
  group_by(strategy) %>%
  dplyr::summarize(mean= mean(fre_exp))

```
  
  
  To test this statistically, we conducted t-test pairwise comparisons to explore the relation between different family language strategies and the amount of French exposure children were getting (See Table 2). French is the majority language in the province of Quebec. We then repeated the process for amount of English exposure (See Table 3). English is not considered a majority language in the province of Quebec, but it is one of Canada's official languages and thus it holds a high linguistic status. We finally repeated the process for amount of minority language exposure (See Table 4). There are many minority languages aside from English that are spoken in the province of Quebec, however they tend to have a lower linguistic status than English.    


```{r results from t tests, include=FALSE}
#Loading results from t-test pairwise comparisons
load(here("results/t_fre.Rda"))
load(here("results/t_eng.Rda"))
load(here("results/t_min.Rda"))

t_fre<- as.data.frame(pwc_exp_fre)
t_eng<- as.data.frame(pwc_exp_eng)
t_min<- as.data.frame(pwc_exp_min)
```
###Table 2
```{r, include=FALSE}
kable(t_fre)
```
##Table 3
```{r}

kable(t_eng)

```

##Table 4
```{r}
kable(t_min)

```

  Finally, we wanted to explore weather families switched in their use of family language strategies across time.To explore this, we used a subset of of our data that included families that had provided LEQ data two separate visits (i.e. longitudinal data). As mentioned in the method section we had a few families that had contributed data to three, four or more data points, however these families were so few we decided not to include data beyond the second point. We wxplored the longitudinal data (See Figure 4) to determine thew stability of family strategy use across time.
  
```{r, include=FALSE}
#select only relevant variables
longitudinal_data <- longitudinal_data %>%
  select(age, strategy, unique_id, anon_baby_id)

longitudinal_data<- longitudinal_data %>%
  arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() 

wider_longitudinal <- longitudinal_data %>%
  select(anon_baby_id, visit, strategy) %>%
  filter(str_detect(strategy, "single-parent", negate=T))

wider_longitudinal <- pivot_wider(wider_longitudinal,
                                names_from = visit, values_from = strategy ) %>%
  rename(visit_1 = "1", visit_2 = "2", visit_3 ="3", visit_4 ="4" ) 



for_sankey <- wider_longitudinal %>%
  make_long(visit_1, visit_2) 

for_sankey <- for_sankey %>%
  mutate(node= fct_relevel (node, "both-parents-bilingual", "one-parent-bilingual", "one-language-at-home", "one-parent-one-lang-flex", "one-parent-one-lang-strict"))

p1<- ggplot(for_sankey, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node), label=node)) +
  geom_sankey() 

p2<- p1+ 
      scale_fill_manual(name= "x", values = c("#f94f80", "#f6cb7f", "#4169e1", "#008c77", "#57bc53"))

p2<- p2 + 
  geom_sankey_label(size=3, color="black", fill="white")+
  theme_bw()+
  theme(legend.position = "none", axis.ticks = element_blank(), axis.text.y = element_blank()) +
  labs(title="Stability of Family Strategies Across Visit", x="")
  

print(p2)
```
  
  Figure 3
```{r}
print(p2)
```
  
  