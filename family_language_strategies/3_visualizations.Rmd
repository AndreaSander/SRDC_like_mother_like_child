---
title: "3_visualizations"
author: "ASM"
date: "27/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggplot2)
library(ggsankey)
```


##----- Sankey graph

```{r}
load(here("anonymized_data/longitudinal_data.Rda"))

#select only relevant variables
longitudinal_data <- longitudinal_data %>%
  select(age, strategy, unique_id, anon_baby_id)

longitudinal_data<- longitudinal_data %>%
  arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() 

wider_longitudinal <- longitudinal_data %>%
  select(anon_baby_id, visit, strategy) %>%
  filter(str_detect(strategy, "single-parent", negate=T))

wider_longitudinal <- pivot_wider(wider_longitudinal,
                                names_from = visit, values_from = strategy ) %>%
  rename(visit_1 = "1", visit_2 = "2", visit_3 ="3", visit_4 ="4" ) 



for_sankey <- wider_longitudinal %>%
  make_long(visit_1, visit_2) 

p1<- ggplot(for_sankey, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node), label=node)) +
  geom_sankey() +
  scale_colour_brewer(palette = "Dark2")

p1<- p1 + 
  geom_sankey_label(size=3, color="black", fill="white")+
  theme_bw()+
  theme(legend.position = "none", axis.ticks = element_blank(), axis.text.y = element_blank())
  


print(p1)
```

```{r}

load(here("anonymized_data/final_data_strat.Rda"))

final_data_strat <- final_data_strat %>%
  mutate(dom_lang_exp = case_when( exp_l1 >= 45 & exp_l1 <= 60 ~"45-60",
                              exp_l1 >= 60.1 & exp_l1 <=75 ~"60-75",
                              exp_l1 >=75.1 & exp_l1 <= 90 ~"75-90",
                              exp_l1 >=90.1 & exp_l1 <=100 ~"90-100"))
    

for_sankey_2 <- final_data_strat %>%
  make_long(strategy, dom_lang_exp) 

p2<- ggplot(for_sankey_2, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node), label=node)) +
  geom_sankey() 


p2<- p2 + 
  geom_sankey_label(size=3, color="black", fill="white")+
  theme_bw()+
  theme(legend.position = "none", axis.ticks = element_blank(), axis.text.y = element_blank()) 

print(p2)
```

