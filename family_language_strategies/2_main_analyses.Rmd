---
title: "2_main_analyses"
author: "ASM"
date: "26/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(dplyr)
library(lme4)
library(lmerTest)
library(rstatix)
library(broom)
library(janitor)
library(glmmTMB)
library(DHARMa)
library(betareg)
library(emmeans)
library(ggeffects)
library(mvtnorm)
library(boot)
library(bbmle)
library(knitr)
library(patchwork)

#Saving my palette to use in visualizations
my_yellow<-"#FFC107"
my_orange<- "#D95F02"
my_blue<- "#1F78B4"
my_green<- "#33a02c"
my_purple<- "#683f6d"
```


#----1. load clean data
```{r}

load(here("anonymized_data/final_merged_data.Rda"))

```


#----2. explore demographics
```{r}

n<- final_data%>%
  distinct(unique_id) #n of 552

gender<- final_data %>%
  distinct(unique_id, gender)%>%
  group_by(gender)%>%
  tally()
#16 na for gender I think from LEQs withouth associated demographics

range(final_data$age, na.rm = T) #4.33 - 30.9 months so 4 - 31 if we round.
```

#------ 4,make french exposure, english exposure and heritage language exposure variables

```{r}


##NOTE: Originally I had also added exposure on language 3 and 4. Language 3 and 4 always amount to less than 10% because we excluded trilinguals. However, 
#in parental interviews caregivers frequently give a third language and the final calculation is so low it amounts to 0 
#this was 0 inflating our english and french exposures, and because we are interested in how bilingual strategies relate to bilingual exposure, I decided to get rid of l3 and 4 exposure when making the frenc, english, and heritage language esposure variables.
            
  

vars<-c("exp_l3", "exp_l4")

final_data_language_coded<-
  final_data %>%
 mutate_at(vars, as.numeric) %>%
  mutate(l3 = replace(l3, l3=="NA", "no lang")) %>%
  mutate(l4 = replace(l4, l4=="NA", "no lang")) %>%
  mutate(fre_exp = case_when(l1=="French"~ exp_l1,
                                l2=="French"~ exp_l2,
                                
                             #l3=="French" & exp_l3 >=1 ~ exp_l3, 
                             #l4=="French"  & exp_l4 >=1 ~ exp_l4
                             ))%>%
    mutate(eng_exp = case_when(l1=="English"~ exp_l1,
                                l2=="English"~ exp_l2,
                                #l3=="English"~ exp_l3,
                                #l4=="English"~ exp_l4
                               )) %>%
  mutate(min_exp = case_when (!(l1 %in% c("French", "English"))& l2 %in% c("French", "English") ~ exp_l1,
                              !(l2 %in% c("French", "English")) & l1 %in% c("French", "English") ~ exp_l2
                              ))


```


#-----3. categorize LEQ data into family language strategies
```{r}
final_data_strat <- final_data_language_coded%>%
  mutate(strategy=case_when(
    
  #one-parent-one-lang-strict: Each parent speaks only one language and both parents don't speak the same language
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1 %in% c("never", "NA") & care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-parent-one-lang",
    
  #one-parent-one-lang-flex: Each parent speaks mainly one language, and one of them sometimes speaks another language
  #(The same language cannot be spoken regularly by both parents or that would be considered a one-parent-bilingual strategy)
    #**NOTE: we ended up having a single category for OPOL instead of divinding it into strict and flex.
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-parent-one-lang",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2=="sometimes"~ "one-parent-one-lang",
    
    
  #one-parent-bilingual: One parent speaks 2 languages, the other parent only speaks one language
    
    #Starting point
    care1_l1== "regularly" & care1_l2=="regularly" & care2_l1 == "regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2 %in% c("never", "NA") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",

    #Some bilingual parents put both of their languages as sometimes rather than both as regularly
    care1_l1== "sometimes" & care1_l2=="sometimes" & care2_l1 == "regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1== "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2 %in% c("never", "NA") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",

    #One parent bilingual (R&R or S&S) and another parent that speaks one of the language but not the other (R|S & N|NA)
    care1_l1 == "regularly" & care1_l2=="regularly" & care2_l1 %in% c("regularly", "sometimes") & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1 == "regularly" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2 %in% c("regularly", "sometimes") ~ "one-parent-bilingual",
    care1_l1 %in% c("regularly", "sometimes") & care1_l2 %in% c("never", "NA") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("regularly", "sometimes") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",

    care1_l1 == "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("regularly", "sometimes") & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1 == "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2 %in% c("regularly", "sometimes") ~ "one-parent-bilingual",
    care1_l1 %in% c("regularly", "sometimes") & care1_l2 %in% c("never", "NA") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("regularly", "sometimes") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    
    #Both parents speak the same language regularly, and one of them speak another language sometimes 
    #(not one-parent-one-lang-flex because both parents use the same language regularly in opposition to each parent having a different language that they use regularly)
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1=="regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="regularly" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA")& care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="sometimes" & care2_l2=="regularly" ~ "one-parent-bilingual",
    
    
  #both-parents-bilingual: Both parents speak both languages either regularly or sometimes
    care1_l1%in% c("regularly", "sometimes") & care1_l2%in% c("regularly", "sometimes") & care2_l1%in% c("regularly", "sometimes") &care2_l2%in% c("regularly", "sometimes") ~ "both-parents-bilingual",

  #one-parent-one-lang-flex: Each parent speaks mainly one language, and one of them sometimes speaks another language
  #The same language cannot be spoken regularly by both parents or it comes to be filled under the one-parent-bilingual strategy.
  #**NOTE: we ended up having a single category for OPOL instead of divinding it into strict and flex.
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-parent-one-lang",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2=="sometimes"~ "one-parent-one-lang",
    
  #one-language-at-home: There is only one language spoken in the home by both parents
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-language-at-home",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly"~ "one-language-at-home",
    
    care1_l1=="sometimes" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2 %in% c("never", "NA")~ "one-language-at-home",
    care1_l1 %in% c("never", "NA") & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2=="sometimes"~ "one-language-at-home",
    
  #single-parent: Family in which there is only one caregiver
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("never", "NA") & care1_l3 %in% c("never", "NA") & care1_l4 %in% c("never", "NA") ~ "single-parent",
    care2_l1 %in% c("never", "NA") & care2_l2 %in% c("never", "NA") & care2_l3 %in% c("never", "NA") & care2_l4 %in% c("never", "NA") ~ "single-parent"
  
    ))
    




# I decided to exclude "true" monolinguals characterized here to the best of our abilities as children whose families use one language at home strategy, and the childcare language is the same as the one language at home strategy = they are being exposed to a single language = most likely not a bilingual strategy.

final_data_strat <-
  final_data_strat %>%
  mutate(bilinugal_strategy= case_when(strategy=="one-language-at-home" & childcare_l1 == l1 & childcare_l2 %in% c(NA, "NA")  ~ "no",
                                       strategy=="one-language-at-home" & childcare_l2 == l1 & childcare_l1 %in% c(NA, "NA") ~"no",
                                       strategy=="one-language-at-home" & childcare_l1 %in% c(NA, "NA") & childcare_l2 %in% c(NA, "NA") ~"no",
                                       TRUE~"yes")) %>%
  filter(bilinugal_strategy=="yes")

#In the end, after discussion we decided to filter all the strictly monolinguals because we are truly interested in bilinguals mainly.

final_data_strat <- 
  final_data_strat %>%
  filter(exp_l1 <95) %>%
  filter(exp_l2 >5)

#Calculate the proportion for the different strategies
prop_strategy<-final_data_strat%>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n))


range(final_data_strat$exp_l1) #47-94
range(final_data_strat$exp_l2) #6-50

#save(final_data_strat, file=here("anonymized_data/final_data_strat.Rda"))


```
#-----3.A Coding language strategies with OPOL separate into two categories
```{r}
final_data_strat_2opol <- final_data_language_coded%>%
  mutate(strategy=case_when(
    
  #one-parent-one-lang-strict: Each parent speaks only one language and both parents don't speak the same language
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1 %in% c("never", "NA") & care2_l2=="regularly"~ "OPOL_S",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "OPOL_S",
    
  #one-parent-one-lang-flex: Each parent speaks mainly one language, and one of them sometimes speaks another language
  #(The same language cannot be spoken regularly by both parents or that would be considered a one-parent-bilingual strategy)
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2=="regularly"~ "OPOL_F",
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") &care2_l2=="regularly"~ "OPOL_F",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "OPOL_F",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2=="sometimes"~ "OPOL_F",
    
    
  #one-parent-bilingual: One parent speaks 2 languages, the other parent only speaks one language
    
    #Starting point
    care1_l1== "regularly" & care1_l2=="regularly" & care2_l1 == "regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2 %in% c("never", "NA") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",

    #Some bilingual parents put both of their languages as sometimes rather than both as regularly
    care1_l1== "sometimes" & care1_l2=="sometimes" & care2_l1 == "regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1== "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1== "regularly" & care1_l2 %in% c("never", "NA") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",

    #One parent bilingual (R&R or S&S) and another parent that speaks one of the language but not the other (R|S & N|NA)
    care1_l1 == "regularly" & care1_l2=="regularly" & care2_l1 %in% c("regularly", "sometimes") & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1 == "regularly" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2 %in% c("regularly", "sometimes") ~ "one-parent-bilingual",
    care1_l1 %in% c("regularly", "sometimes") & care1_l2 %in% c("never", "NA") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("regularly", "sometimes") & care2_l1 == "regularly" & care2_l2=="regularly" ~ "one-parent-bilingual",

    care1_l1 == "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("regularly", "sometimes") & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1 == "sometimes" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2 %in% c("regularly", "sometimes") ~ "one-parent-bilingual",
    care1_l1 %in% c("regularly", "sometimes") & care1_l2 %in% c("never", "NA") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("regularly", "sometimes") & care2_l1 == "sometimes" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    
    #Both parents speak the same language regularly, and one of them speak another language sometimes 
    #(not one-parent-one-lang-flex because both parents use the same language regularly in opposition to each parent having a different language that they use regularly)
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1=="regularly" & care2_l2 %in% c("never", "NA") ~ "one-parent-bilingual",
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="regularly" & care2_l2=="sometimes" ~ "one-parent-bilingual",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1 %in% c("never", "NA")& care2_l2=="regularly" ~ "one-parent-bilingual",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="sometimes" & care2_l2=="regularly" ~ "one-parent-bilingual",
    
    
  #both-parents-bilingual: Both parents speak both languages either regularly or sometimes
    care1_l1%in% c("regularly", "sometimes") & care1_l2%in% c("regularly", "sometimes") & care2_l1%in% c("regularly", "sometimes") &care2_l2%in% c("regularly", "sometimes") ~ "both-parents-bilingual",

  #one-parent-one-lang-flex: Each parent speaks mainly one language, and one of them sometimes speaks another language
  #The same language cannot be spoken regularly by both parents or it comes to be filled under the one-parent-bilingual strategy.
  #**NOTE: we ended up having a single category for OPOL instead of divinding it into strict and flex.
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="regularly" & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") &care2_l2=="regularly"~ "one-parent-one-lang",
    care1_l1=="sometimes" & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-parent-one-lang",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1=="regularly" &care2_l2=="sometimes"~ "one-parent-one-lang",
    
  #one-language-at-home: There is only one language spoken in the home by both parents
    care1_l1=="regularly" & care1_l2 %in% c("never", "NA") & care2_l1=="regularly" &care2_l2 %in% c("never", "NA")~ "one-language-at-home",
    care1_l1 %in% c("never", "NA") & care1_l2=="regularly" & care2_l1 %in% c("never", "NA") & care2_l2=="regularly"~ "one-language-at-home",
    
    care1_l1=="sometimes" & care1_l2 %in% c("never", "NA") & care2_l1=="sometimes" &care2_l2 %in% c("never", "NA")~ "one-language-at-home",
    care1_l1 %in% c("never", "NA") & care1_l2=="sometimes" & care2_l1 %in% c("never", "NA") & care2_l2=="sometimes"~ "one-language-at-home",
    
  #single-parent: Family in which there is only one caregiver
    care1_l1 %in% c("never", "NA") & care1_l2 %in% c("never", "NA") & care1_l3 %in% c("never", "NA") & care1_l4 %in% c("never", "NA") ~ "single-parent",
    care2_l1 %in% c("never", "NA") & care2_l2 %in% c("never", "NA") & care2_l3 %in% c("never", "NA") & care2_l4 %in% c("never", "NA") ~ "single-parent"
  
    ))
    

final_data_strat_2opol <-
  final_data_strat_2opol %>%
  mutate(bilinugal_strategy= case_when(strategy=="one-language-at-home" & childcare_l1 == l1 & childcare_l2 %in% c(NA, "NA")  ~ "no",
                                       strategy=="one-language-at-home" & childcare_l2 == l1 & childcare_l1 %in% c(NA, "NA") ~"no",
                                       strategy=="one-language-at-home" & childcare_l1 %in% c(NA, "NA") & childcare_l2 %in% c(NA, "NA") ~"no",
                                       TRUE~"yes")) %>%
  filter(bilinugal_strategy=="yes")

final_data_strat_2opol <- 
  final_data_strat_2opol %>%
  filter(exp_l1 <95) %>%
  filter(exp_l2 >5)


#Calculate the proportion for the different strategies
prop_strategy_2opol<-final_data_strat_2opol%>%
group_by(strategy) %>%
  tally() %>%
  mutate(prop = n/sum(n))


```



#---- coding minority versus majority language
```{r}

final_data_strat <- final_data_strat %>% 
  mutate(lang_status = case_when(
    l2=="NA" ~ "monolingual",
    exp_l2== 0 ~ "monolingual",
    l1 %in% c("French", "English") & l2 %in% c("French", "English") ~ "both_maj",
     l1 %in% c("French", "English") & !(l2 %in% c("French", "English")) ~ "one_maj",
    !(l1 %in% c("French", "English")) & l2 %in% c("French", "English") ~ "one_maj",
    TRUE ~ "both_min"
  ))

#do check that the monolinguals are actually monolinguals and not both min


#subseting to get data only from each child's first visit to the lab. For main analyses
first_visit_only <- final_data_strat%>%
    arrange(anon_baby_id, age) %>%
  group_by(anon_baby_id) %>%
  mutate(visit = row_number()) %>%
  ungroup() %>%
  filter (visit==1)

```


###PERFORMING ANOVAS AND POST HOC TESTS --> LANG EXP PREDICTOR
```{r}
#filtering the single parent cases because there are not enough to have any power statistically.
for_anovas<- first_visit_only %>%
  filter(!strategy == "single-parent")

anova_model_french <- aov(fre_exp ~ strategy, data= for_anovas)

tidy(anova_model_french)
tukey_hsd(anova_model_french)


anova_model_english <- aov(eng_exp ~ strategy, data= for_anovas)
tidy(anova_model_english)
tukey_hsd(anova_model_english)

anova_model_heritage <- aov(min_exp ~ strategy, data= for_anovas)
tidy(anova_model_heritage)
```

###PERFORMING ANOVAS AND POST HOC TESTS --> LANG BALANCE PREDICTOR
```{r}
for_blc_anova <- first_visit_only %>%
  filter(!strategy == "single-parent") %>%
  mutate(strategy = case_when(strategy=="both-parents-bilingual"~"BothParentsBilingual",
                              strategy=="one-language-at-home"~"OneLanguageAtHome",
                              strategy=="one-parent-bilingual"~"OneParentBilingual",
                              strategy=="one-parent-one-lang"~"OneParentOneLang"))

#blc_anova_fre <- for_blc_anova %>%
#  filter(l2=="French")

#blc_model_french <- aov(exp_l2 ~ strategy, data = blc_anova_fre)
#tidy(blc_model_french)
#tukey_hsd(blc_model_french)

######################################

#blc_anova_eng <- for_blc_anova %>%
#  filter(l2=="English")

#blc_model_english <- aov(exp_l2 ~ strategy, data= blc_anova_eng)
#tidy(blc_model_english)
#tukey_hsd(blc_model_english)

#####################################

#blc_anova_her <- for_blc_anova %>%
#  filter (!l2 %in% c("French", "English"))

#blc_model_heritage <- aov(exp_l2 ~ strategy, data= blc_anova_her)
#tidy(blc_model_heritage)
#tukey_hsd(blc_model_heritage)

####################################
blc_model <- aov(exp_l2 ~ strategy, data= for_blc_anova)
tidy(blc_model)
blc_tukey<- tukey_hsd(blc_model)
kable(blc_tukey)



balance <- first_visit_only  %>%
  select(c(strategy, exp_l2)) %>%
  group_by(strategy) %>%
  dplyr::summarize(
    sd= sd(exp_l2, na.rm=TRUE),
    mean= mean(exp_l2,  na.rm=TRUE)) %>%
  arrange(desc("mean(exp_l2, na.rm=TRUE)")) 

balance$strategy<- factor(balance$strategy, levels= c("both-parents-bilingual", "one-parent-bilingual", "one-parent-one-lang", "one-language-at-home", "single-parent"))

ggplot(balance, aes( x=strategy , y=mean, fill = strategy, ymin = mean, ymax = mean+sd )) +
  geom_col() +
  geom_errorbar(width=0.2)+
   #scale_fill_manual (name = "Family Strategy", values =c(my_orange, my_yellow, my_blue, my_green, my_purple)) +
  theme_bw() +
    theme(axis.text.x = element_blank())+
  labs(title= "Mean exposure balance by strategy")


  ```



#---------- create and save longitudinal data frame
```{r}
#keeps only data where the baby participated more than once
longitudinal_data<- final_data_strat %>%
  add_count(anon_baby_id) %>%
  filter(nn>1)

save(longitudinal_data, file=here("anonymized_data/longitudinal_data.Rda"))
```



#Explore beta regressions
```{r}
# Create the dataframes to run the models for each language. Monolinguals are excluded, as are the rows 
# where exposure for a given language equals 100. Since exposure is on a 0-100 scale and the beta distributions 
# works with values ranging from 0-1, exposure is divided by 100. 
for_beta <- for_anovas %>% 
  select(gender, anon_baby_id, age, fre_exp, eng_exp, min_exp, strategy, lang_status) %>% 
  filter(lang_status != "monolingual") %>% 
  filter(gender != "NA") %>%
  filter(!strategy == "one-language-at-home")

for_beta_blc <- for_blc_anova %>% 
  select(gender, anon_baby_id, age, exp_l2, strategy, lang_status) %>% 
  filter(lang_status != "monolingual") %>% 
  filter(gender != "NA") %>%
    filter(!strategy == "OneLanguageAtHome")



# Dataframe for english exposure
for_beta_eng <- for_beta %>% 
  select(age, eng_exp, strategy, lang_status, anon_baby_id) %>% 
  filter(eng_exp != "NA") %>% 
  filter(eng_exp !=100) %>% 
  mutate(eng_exp = eng_exp/100,
         strategy = as.factor(strategy), 
         lang_status = as.factor(lang_status))

# Dataframe for french exposure
for_beta_fre <- for_beta %>% 
  select(age, fre_exp, strategy, lang_status, anon_baby_id) %>%
  filter(fre_exp != "NA") %>% 
  filter(fre_exp != 100) %>% 
  mutate(fre_exp = fre_exp/100, 
         strategy = as.factor(strategy), 
         lang_status = as.factor(lang_status))

# Dataframe for minority language exposure
for_beta_min <- for_beta %>% 
  select(age, min_exp, strategy, lang_status, anon_baby_id) %>%
  filter(min_exp != "NA") %>% 
  filter(min_exp !=100) %>% 
  mutate(min_exp = min_exp/100,
         strategy = as.factor(strategy), 
         lang_status = as.factor(lang_status))

#Dataframe for balance
for_balance<- for_beta_blc%>% 
  select(age, exp_l2, strategy, lang_status, anon_baby_id) %>%
  filter(exp_l2 != "NA") %>% 
  mutate(exp_l2 = exp_l2/100,
         strategy = as.factor(strategy), 
         lang_status = as.factor(lang_status))


m4b <- glmmTMB(eng_exp ~ strategy * age, data=for_beta_eng, family= beta_family(link="logit"), dispformula = ~ strategy * age)
summary(m4b) # No significant effects, except for the intercept which is both parents bilingual?

# We run model diagnostics with DHARMa
sim_m4b <- simulateResiduals(m4b)
plot(sim_m4b) # MODEL OK!
testDispersion(sim_m4b) # MODEL OK!

# We can plot the fixed effects for m4b, the best model so far (very interesting!)
m4b_effects <- ggpredict(m4b, terms = c("age", "strategy"))
custom_palette = c(my_orange, my_yellow, my_blue)
figure_3a<- plot(m4b_effects, add.data = F, colors= custom_palette, alpha=.05)+
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=22), legend.position = "none")+
  labs(title= "A. Predicted values of English")


# We can estimate and compare the marginal means of the response variable across different levels of "strategy", while accounting for the effect of "age" and the varying dispersion parameter. This code computes pairwise comparisons of the estimated marginal means of eng_exp across the different levels of "strategy", while holding "age" constant at its mean value.
emtrends(m4b, pairwise ~ strategy, var="age") # trend for one-language-at-home significantly different from that of one parent-bilingual


# MODEL FOR FRENCH EXPOSURE + VISUALIZATION
m5 <- glmmTMB(fre_exp ~ strategy * age, data=for_beta_fre, family= beta_family(link="logit"), dispformula = ~ strategy * age)
summary(m5) # same as English only for the intercept.

# We run model diagnostics with DHARMa
sim_m5 <- simulateResiduals(m5)
plot(sim_m5) # MODEL OK!
testDispersion(sim_m5) # MODEL OK!

# We can plot the fixed effects for m5, the best model so far
m5_effects <- ggpredict(m5, terms = c("age", "strategy"))
custom_palette = c(my_orange, my_yellow, my_blue)
figure_3b<- plot(m5_effects, add.data = F, colors= custom_palette, alpha=.05)+
        theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=22), legend.text= element_text(size=20), legend.title= element_text(size=20))+
  labs(title= "B. Predicted values of French")

# We can estimate and compare the marginal means of the response variable across different levels of "strategy", while accounting for the effect of "age" and the varying dispersion parameter. 
emtrends(m5, pairwise ~ strategy, var="age") # no significant results

# MODEL FOR MINORITY LANGUAGE EXPOSURE + VISUALIZATION
m6 <- glmmTMB(min_exp ~ strategy * age, data=for_beta_min, family= beta_family(link="logit"), dispformula = ~ strategy + age)
summary(m6) # Significant effects for one-language-at-home and its interaction with age and with age is a significant predictor.

# We run model diagnostics with DHARMa
sim_m6 <- simulateResiduals(m6)
plot(sim_m6) # MODEL OK!
testDispersion(sim_m6) # MODEL OK!

# We can plot the fixed effects for m6, the best model so far (very interesting!)
m6_effects <- ggpredict(m6, terms = c("age", "strategy"))
custom_palette = c(my_orange, my_yellow, my_blue)
figure_3c<- plot(m6_effects, add.data = F, colors= custom_palette, alpha=.05) +
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=22), legend.position = "none")+
  labs(title= "C. Predicted values of HL")

# We can estimate and compare the marginal means of the response variable across different levels of "strategy", while accounting for the effect of "age" and the varying dispersion parameter. 
emtrends(m6, pairwise ~ strategy, var="age") # # trend for one-language-at-home significantly different from that of one parent-bilingual


m7<- glmmTMB(exp_l2 ~ strategy * age, data=for_balance, family= beta_family(link="logit"), dispformula = ~ strategy + age)
summary(m7)


m7_effects <- ggpredict(m7, terms = c("age", "strategy"))
custom_palette = c(my_orange, my_yellow, my_blue)
figure_3d<- plot(m7_effects, add.data = F, colors= custom_palette, alpha=.05)+
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size=20),axis.title = element_text(size=20), plot.title = element_text(size=22), legend.position = "none")+
  labs(title= "D. Predicted values of Exposure Balance")

figure_3<- figure_3a + figure_3b + figure_3c + figure_3d
```

